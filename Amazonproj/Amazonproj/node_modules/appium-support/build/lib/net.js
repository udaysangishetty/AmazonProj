"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.uploadFile = uploadFile;
exports.downloadFile = downloadFile;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs = _interopRequireDefault(require("./fs"));

var _url = _interopRequireDefault(require("url"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _util = require("./util");

var _logger = _interopRequireDefault(require("./logger"));

var _jsftp = _interopRequireDefault(require("jsftp"));

var _timing = _interopRequireDefault(require("./timing"));

var _axios = _interopRequireDefault(require("axios"));

var _formData = _interopRequireDefault(require("form-data"));

function toAxiosAuth(auth) {
  if (!_lodash.default.isPlainObject(auth)) {
    return null;
  }

  const axiosAuth = {
    username: auth.username || auth.user,
    password: auth.password || auth.pass
  };
  return axiosAuth.username && axiosAuth.password ? axiosAuth : null;
}

async function uploadFileToHttp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    method = 'POST',
    timeout = 5000,
    headers,
    auth,
    fileFieldName = 'file',
    formFields
  } = uploadOptions;
  const {
    protocol,
    href
  } = parsedUri;
  const requestOpts = {
    url: href,
    method,
    timeout
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  const form = new _formData.default();
  form.append(fileFieldName, localFileStream);

  if (formFields) {
    let pairs = [];

    if (_lodash.default.isArray(formFields)) {
      pairs = formFields;
    } else if (_lodash.default.isPlainObject(formFields)) {
      pairs = _lodash.default.toPairs(formFields);
    }

    for (const [key, value] of pairs) {
      if (_lodash.default.toLower(key) !== _lodash.default.toLower(fileFieldName)) {
        form.append(key, value);
      }
    }
  }

  requestOpts.headers = Object.assign({}, _lodash.default.isPlainObject(headers) ? headers : {}, form.getHeaders());

  _logger.default.debug(`${protocol} upload options (ex. form data): ${JSON.stringify(requestOpts)}`);

  requestOpts.data = form;
  await (0, _axios.default)(requestOpts);
}

async function uploadFileToFtp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    auth,
    user,
    pass
  } = uploadOptions;
  const {
    hostname,
    port,
    protocol,
    pathname
  } = parsedUri;
  const ftpOpts = {
    host: hostname,
    port: port || 21
  };

  if ((auth === null || auth === void 0 ? void 0 : auth.user) && (auth === null || auth === void 0 ? void 0 : auth.pass) || user && pass) {
    ftpOpts.user = (auth === null || auth === void 0 ? void 0 : auth.user) || user;
    ftpOpts.pass = (auth === null || auth === void 0 ? void 0 : auth.pass) || pass;
  }

  _logger.default.debug(`${protocol} upload options: ${JSON.stringify(ftpOpts)}`);

  return await new _bluebird.default((resolve, reject) => {
    new _jsftp.default(ftpOpts).put(localFileStream, pathname, err => {
      if (err) {
        reject(err);
      } else {
        resolve();
      }
    });
  });
}

async function uploadFile(localPath, remoteUri, uploadOptions = {}) {
  if (!(await _fs.default.exists(localPath))) {
    throw new Error(`'${localPath}' does not exists or is not accessible`);
  }

  const {
    isMetered = true
  } = uploadOptions;

  const parsedUri = _url.default.parse(remoteUri);

  const {
    size
  } = await _fs.default.stat(localPath);

  if (isMetered) {
    _logger.default.info(`Uploading '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size to '${remoteUri}'...`);
  }

  const timer = new _timing.default().start();

  if (['http:', 'https:'].includes(parsedUri.protocol)) {
    await uploadFileToHttp(_fs.default.createReadStream(localPath), parsedUri, uploadOptions);
  } else if (parsedUri.protocol === 'ftp:') {
    await uploadFileToFtp(_fs.default.createReadStream(localPath), parsedUri, uploadOptions);
  } else {
    throw new Error(`Cannot upload the file at '${localPath}' to '${remoteUri}'. ` + `Unsupported remote protocol '${parsedUri.protocol}'. ` + `Only http/https and ftp/ftps protocols are supported.`);
  }

  if (isMetered) {
    _logger.default.info(`Uploaded '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size in ${timer.getDuration().asSeconds.toFixed(3)}s`);
  }
}

async function downloadFile(remoteUrl, dstPath, downloadOptions = {}) {
  const {
    isMetered = true,
    auth,
    timeout = 5000,
    headers
  } = downloadOptions;
  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  if (_lodash.default.isPlainObject(headers)) {
    requestOpts.headers = headers;
  }

  const timer = new _timing.default().start();

  try {
    const writer = _fs.default.createWriteStream(dstPath);

    const responseStream = (await (0, _axios.default)(requestOpts)).data;
    responseStream.pipe(writer);
    await new _bluebird.default((resolve, reject) => {
      responseStream.once('error', reject);
      writer.once('finish', resolve);
      writer.once('error', e => {
        responseStream.unpipe(writer);
        reject(e);
      });
    });
  } catch (err) {
    throw new Error(`Cannot download the file from ${remoteUrl}: ${err.message}`);
  }

  if (!isMetered) {
    return;
  }

  const secondsElapsed = timer.getDuration().asSeconds;
  const {
    size
  } = await _fs.default.stat(dstPath);

  _logger.default.debug(`${remoteUrl} (${(0, _util.toReadableSizeString)(size)}) ` + `has been downloaded to '${dstPath}' in ${secondsElapsed.toFixed(3)}s`);

  if (secondsElapsed >= 2) {
    const bytesPerSec = Math.floor(size / secondsElapsed);

    _logger.default.debug(`Approximate download speed: ${(0, _util.toReadableSizeString)(bytesPerSec)}/s`);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9uZXQuanMiXSwibmFtZXMiOlsidG9BeGlvc0F1dGgiLCJhdXRoIiwiXyIsImlzUGxhaW5PYmplY3QiLCJheGlvc0F1dGgiLCJ1c2VybmFtZSIsInVzZXIiLCJwYXNzd29yZCIsInBhc3MiLCJ1cGxvYWRGaWxlVG9IdHRwIiwibG9jYWxGaWxlU3RyZWFtIiwicGFyc2VkVXJpIiwidXBsb2FkT3B0aW9ucyIsIm1ldGhvZCIsInRpbWVvdXQiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJwcm90b2NvbCIsImhyZWYiLCJyZXF1ZXN0T3B0cyIsInVybCIsImZvcm0iLCJGb3JtRGF0YSIsImFwcGVuZCIsInBhaXJzIiwiaXNBcnJheSIsInRvUGFpcnMiLCJrZXkiLCJ2YWx1ZSIsInRvTG93ZXIiLCJPYmplY3QiLCJhc3NpZ24iLCJnZXRIZWFkZXJzIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5IiwiZGF0YSIsInVwbG9hZEZpbGVUb0Z0cCIsImhvc3RuYW1lIiwicG9ydCIsInBhdGhuYW1lIiwiZnRwT3B0cyIsImhvc3QiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsIkZ0cCIsInB1dCIsImVyciIsInVwbG9hZEZpbGUiLCJsb2NhbFBhdGgiLCJyZW1vdGVVcmkiLCJmcyIsImV4aXN0cyIsIkVycm9yIiwiaXNNZXRlcmVkIiwicGFyc2UiLCJzaXplIiwic3RhdCIsImluZm8iLCJ0aW1lciIsIlRpbWVyIiwic3RhcnQiLCJpbmNsdWRlcyIsImNyZWF0ZVJlYWRTdHJlYW0iLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJkb3dubG9hZEZpbGUiLCJyZW1vdGVVcmwiLCJkc3RQYXRoIiwiZG93bmxvYWRPcHRpb25zIiwicmVzcG9uc2VUeXBlIiwid3JpdGVyIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJyZXNwb25zZVN0cmVhbSIsInBpcGUiLCJvbmNlIiwiZSIsInVucGlwZSIsIm1lc3NhZ2UiLCJzZWNv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QUNkLE9BQWYsQ0FBdUIsQ0FBdkIsQ0FBMEIsR0FEdEU7O0FBRUEsTUFBSWMsY0FBYyxJQUFJLENBQXRCLEVBQXlCO0FBQ3ZCLFVBQU1DLFdBQVcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVczQixJQUFJLEdBQUd3QixjQUFsQixDQUFwQjs7QUFDQWpELG9CQUFJQyxLQUFKLENBQVcsK0JBQThCLGdDQUFxQmlELFdBQXJCLENBQWtDLElBQTNFO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZnMgZnJvbSAnLi9mcyc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB0b1JlYWRhYmxlU2l6ZVN0cmluZyB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBGdHAgZnJvbSAnanNmdHAnO1xuaW1wb3J0IFRpbWVyIGZyb20gJy4vdGltaW5nJztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgRm9ybURhdGEgZnJvbSAnZm9ybS1kYXRhJztcblxuXG5mdW5jdGlvbiB0b0F4aW9zQXV0aCAoYXV0aCkge1xuICBpZiAoIV8uaXNQbGFpbk9iamVjdChhdXRoKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgYXhpb3NBdXRoID0ge1xuICAgIHVzZXJuYW1lOiBhdXRoLnVzZXJuYW1lIHx8IGF1dGgudXNlcixcbiAgICBwYXNzd29yZDogYXV0aC5wYXNzd29yZCB8fCBhdXRoLnBhc3MsXG4gIH07XG4gIHJldHVybiAoYXhpb3NBdXRoLnVzZXJuYW1lICYmIGF4aW9zQXV0aC5wYXNzd29yZCkgPyBheGlvc0F1dGggOiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlVG9IdHRwIChsb2NhbEZpbGVTdHJlYW0sIHBhcnNlZFVyaSwgdXBsb2FkT3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBtZXRob2QgPSAnUE9TVCcsXG4gICAgdGltZW91dCA9IDUwMDAsXG4gICAgaGVhZGVycyxcbiAgICBhdXRoLFxuICAgIGZpbGVGaWVsZE5hbWUgPSAnZmlsZScsXG4gICAgZm9ybUZpZWxkcyxcbiAgfSA9IHVwbG9hZE9wdGlvbnM7XG4gIGNvbnN0IHtcbiAgICBwcm90b2NvbCxcbiAgICBocmVmLFxuICB9ID0gcGFyc2VkVXJpO1xuXG4gIGNvbnN0IHJlcXVlc3RPcHRzID0ge1xuICAgIHVybDogaHJlZixcbiAgICBtZXRob2QsXG4gICAgdGltZW91dCxcbiAgfTtcbiAgY29uc3QgYXhpb3NBdXRoID0gdG9BeGlvc0F1dGgoYXV0aCk7XG4gIGlmIChheGlvc0F1dGgpIHtcbiAgICByZXF1ZXN0T3B0cy5hdXRoID0gYXhpb3NBdXRoO1xuICB9XG4gIGNvbnN0IGZvcm0gPSBuZXcgRm9ybURhdGEoKTtcbiAgZm9ybS5hcHBlbmQoZmlsZUZpZWxkTmFtZSwgbG9jYWxGaWxlU3RyZWFtKTtcbiAgaWYgKGZvcm1GaWVsZHMpIHtcbiAgICBsZXQgcGFpcnMgPSBbXTtcbiAgICBpZiAoXy5pc0FycmF5KGZvcm1GaWVsZHMpKSB7XG4gICAgICBwYWlycyA9IGZvcm1GaWVsZHM7XG4gICAgfSBlbHNlIGlmIChfLmlzUGxhaW5PYmplY3QoZm9ybUZpZWxkcykpIHtcbiAgICAgIHBhaXJzID0gXy50b1BhaXJzKGZvcm1GaWVsZHMpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBwYWlycykge1xuICAgICAgaWYgKF8udG9Mb3dlcihrZXkpICE9PSBfLnRvTG93ZXIoZmlsZUZpZWxkTmFtZSkpIHtcbiAgICAgICAgZm9ybS5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJlcXVlc3RPcHRzLmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBfLmlzUGxhaW5PYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDoge30sIGZvcm0uZ2V0SGVhZGVycygpKTtcblxuICAvLyBleGNsdWRlIGZvcm0gZGF0YSBmcm9tIHRoZSBsb2cgc2luY2UgaXQnbGwgY29udGFpbiB0aGUgZW50aXJlIHJlY29yZGVkIHZpZGVvXG4gIGxvZy5kZWJ1ZyhgJHtwcm90b2NvbH0gdXBsb2FkIG9wdGlvbnMgKGV4LiBmb3JtIGRhdGEpOiAke0pTT04uc3RyaW5naWZ5KHJlcXVlc3RPcHRzKX1gKTtcbiAgcmVxdWVzdE9wdHMuZGF0YSA9IGZvcm07XG5cbiAgYXdhaXQgYXhpb3MocmVxdWVzdE9wdHMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlVG9GdHAgKGxvY2FsRmlsZVN0cmVhbSwgcGFyc2VkVXJpLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGF1dGgsXG4gICAgdXNlcixcbiAgICBwYXNzLFxuICB9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3Qge1xuICAgIGhvc3RuYW1lLFxuICAgIHBvcnQsXG4gICAgcHJvdG9jb2wsXG4gICAgcGF0aG5hbWUsXG4gIH0gPSBwYXJzZWRVcmk7XG5cbiAgY29uc3QgZnRwT3B0cyA9IHtcbiAgICBob3N0OiBob3N0bmFtZSxcbiAgICBwb3J0OiBwb3J0IHx8IDIxLFxuICB9O1xuICBpZiAoKGF1dGg/LnVzZXIgJiYgYXV0aD8ucGFzcykgfHwgKHVzZXIgJiYgcGFzcykpIHtcbiAgICBmdHBPcHRzLnVzZXIgPSBhdXRoPy51c2VyIHx8IHVzZXI7XG4gICAgZnRwT3B0cy5wYXNzID0gYXV0aD8ucGFzcyB8fCBwYXNzO1xuICB9XG4gIGxvZy5kZWJ1ZyhgJHtwcm90b2NvbH0gdXBsb2FkIG9wdGlvbnM6ICR7SlNPTi5zdHJpbmdpZnkoZnRwT3B0cyl9YCk7XG4gIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgbmV3IEZ0cChmdHBPcHRzKS5wdXQobG9jYWxGaWxlU3RyZWFtLCBwYXRobmFtZSwgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQXV0aENyZWRlbnRpYWxzXG4gKiBAcHJvcGVydHkge3N0cmluZ30gdXNlciAtIE5vbi1lbXB0eSB1c2VyIG5hbWVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwYXNzIC0gTm9uLWVtcHR5IHBhc3N3b3JkXG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBGdHBVcGxvYWRPcHRpb25zXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTWV0ZXJlZCBbdHJ1ZV0gLSBXaGV0aGVyIHRvIGxvZyB0aGUgYWN0dWFsIHVwbG9hZCBwZXJmb3JtYW5jZVxuICogKGUuZy4gdGltaW5ncyBhbmQgc3BlZWQpXG4gKiBAcHJvcGVydHkge0F1dGhDcmVkZW50aWFsc30gYXV0aFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSHR0cFVwbG9hZE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNNZXRlcmVkIFt0cnVlXSAtIFdoZXRoZXIgdG8gbG9nIHRoZSBhY3R1YWwgdXBsb2FkIHBlcmZvcm1hbmNlXG4gKiAoZS5nLiB0aW1pbmdzIGFuZCBzcGVlZClcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBtZXRob2QgW1BPU1RdIC0gVGhlIEhUVFAgbWV0aG9kIHVzZWQgZm9yIGZpbGUgdXBsb2FkXG4gKiBAcHJvcGVydHkge0F1dGhDcmVkZW50aWFsc30gYXV0aFxuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXQgWzUwMDBdIC0gVGhlIGFjdHVhbCByZXF1ZXN0IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzXG4gKiBAcHJvcGVydHkge09iamVjdH0gaGVhZGVycyAtIEFkZGl0aW9uYWwgcmVxdWVzdCBoZWFkZXJzIG1hcHBpbmdcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkIGNvbnRhaW5pbmcgdGhlIGZpbGVcbiAqIGNvbnRlbnQgdG8gYmUgdXBsb2FkZWRcbiAqIEBwcm9wZXJ0eSB7QXJyYXk8UGFpcj58T2JqZWN0fSBmb3JtRmllbGRzIC0gVGhlIGFkZGl0aW9uYWwgZm9ybSBmaWVsZHNcbiAqIHRvIGJlIGluY2x1ZGVkIGludG8gdGhlIHVwbG9hZCByZXF1ZXN0LiBUaGlzIHByb3BlcnR5IGlzIG9ubHkgY29uc2lkZXJlZCBpZlxuICogYGZpbGVGaWVsZE5hbWVgIGlzIHNldFxuICovXG5cbi8qKlxuICogVXBsb2FkcyB0aGUgZ2l2ZW4gZmlsZSB0byBhIHJlbW90ZSBsb2NhdGlvbi4gSFRUUChTKSBhbmQgRlRQXG4gKiBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxQYXRoIC0gVGhlIHBhdGggdG8gYSBmaWxlIG9uIHRoZSBsb2NhbCBzdG9yYWdlLlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVVyaSAtIFRoZSByZW1vdGUgVVJJIHRvIHVwbG9hZCB0aGUgZmlsZSB0by5cbiAqIEBwYXJhbSB7P0Z0cFVwbG9hZE9wdGlvbnN8SHR0cFVwbG9hZE9wdGlvbnN9IHVwbG9hZE9wdGlvbnNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gdXBsb2FkRmlsZSAobG9jYWxQYXRoLCByZW1vdGVVcmksIHVwbG9hZE9wdGlvbnMgPSB7fSkge1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhsb2NhbFBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yIChgJyR7bG9jYWxQYXRofScgZG9lcyBub3QgZXhpc3RzIG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICBjb25zdCB7XG4gICAgaXNNZXRlcmVkID0gdHJ1ZSxcbiAgfSA9IHVwbG9hZE9wdGlvbnM7XG5cbiAgY29uc3QgcGFyc2VkVXJpID0gdXJsLnBhcnNlKHJlbW90ZVVyaSk7XG4gIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQobG9jYWxQYXRoKTtcbiAgaWYgKGlzTWV0ZXJlZCkge1xuICAgIGxvZy5pbmZvKGBVcGxvYWRpbmcgJyR7bG9jYWxQYXRofScgb2YgJHt0b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX0gc2l6ZSB0byAnJHtyZW1vdGVVcml9Jy4uLmApO1xuICB9XG4gIGNvbnN0IHRpbWVyID0gbmV3IFRpbWVyKCkuc3RhcnQoKTtcbiAgaWYgKFsnaHR0cDonLCAnaHR0cHM6J10uaW5jbHVkZXMocGFyc2VkVXJpLnByb3RvY29sKSkge1xuICAgIGF3YWl0IHVwbG9hZEZpbGVUb0h0dHAoZnMuY3JlYXRlUmVhZFN0cmVhbShsb2NhbFBhdGgpLCBwYXJzZWRVcmksIHVwbG9hZE9wdGlvbnMpO1xuICB9IGVsc2UgaWYgKHBhcnNlZFVyaS5wcm90b2NvbCA9PT0gJ2Z0cDonKSB7XG4gICAgYXdhaXQgdXBsb2FkRmlsZVRvRnRwKGZzLmNyZWF0ZVJlYWRTdHJlYW0obG9jYWxQYXRoKSwgcGFyc2VkVXJpLCB1cGxvYWRPcHRpb25zKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB1cGxvYWQgdGhlIGZpbGUgYXQgJyR7bG9jYWxQYXRofScgdG8gJyR7cmVtb3RlVXJpfScuIGAgK1xuICAgICAgYFVuc3VwcG9ydGVkIHJlbW90ZSBwcm90b2NvbCAnJHtwYXJzZWRVcmkucHJvdG9jb2x9Jy4gYCArXG4gICAgICBgT25seSBodHRwL2h0dHBzIGFuZCBmdHAvZnRwcyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxuICBpZiAoaXNNZXRlcmVkKSB7XG4gICAgbG9nLmluZm8oYFVwbG9hZGVkICcke2xvY2FsUGF0aH0nIG9mICR7dG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9IHNpemUgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IERvd25sb2FkT3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSBpc01ldGVyZWQgW3RydWVdIC0gV2hldGhlciB0byBsb2cgdGhlIGFjdHVhbCBkb3dubG9hZCBwZXJmb3JtYW5jZVxuICogKGUuZy4gdGltaW5ncyBhbmQgc3BlZWQpXG4gKiBAcHJvcGVydHkge0F1dGhDcmVkZW50aWFsc30gYXV0aFxuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXQgWzUwMDBdIC0gVGhlIGFjdHVhbCByZXF1ZXN0IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzXG4gKiBAcHJvcGVydHkge09iamVjdH0gaGVhZGVycyAtIFJlcXVlc3QgaGVhZGVycyBtYXBwaW5nXG4gKi9cblxuLyoqXG4gKiBEb3dubG9hZHMgdGhlIGdpdmVuIGZpbGUgdmlhIEhUVFAoUylcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlVXJsIC0gVGhlIHJlbW90ZSB1cmxcbiAqIEBwYXJhbSB7c3RyaW5nfSBkc3RQYXRoIC0gVGhlIGxvY2FsIHBhdGggdG8gZG93bmxvYWQgdGhlIGZpbGUgdG9cbiAqIEBwYXJhbSB7P0Rvd25sb2FkT3B0aW9uc30gZG93bmxvYWRPcHRpb25zXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZG93bmxvYWQgb3BlcmF0aW9uIGZhaWxzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkRmlsZSAocmVtb3RlVXJsLCBkc3RQYXRoLCBkb3dubG9hZE9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaXNNZXRlcmVkID0gdHJ1ZSxcbiAgICBhdXRoLFxuICAgIHRpbWVvdXQgPSA1MDAwLFxuICAgIGhlYWRlcnMsXG4gIH0gPSBkb3dubG9hZE9wdGlvbnM7XG5cbiAgY29uc3QgcmVxdWVzdE9wdHMgPSB7XG4gICAgdXJsOiByZW1vdGVVcmwsXG4gICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJyxcbiAgICB0aW1lb3V0LFxuICB9O1xuICBjb25zdCBheGlvc0F1dGggPSB0b0F4aW9zQXV0aChhdXRoKTtcbiAgaWYgKGF4aW9zQXV0aCkge1xuICAgIHJlcXVlc3RPcHRzLmF1dGggPSBheGlvc0F1dGg7XG4gIH1cbiAgaWYgKF8uaXNQbGFpbk9iamVjdChoZWFkZXJzKSkge1xuICAgIHJlcXVlc3RPcHRzLmhlYWRlcnMgPSBoZWFkZXJzO1xuICB9XG5cbiAgY29uc3QgdGltZXIgPSBuZXcgVGltZXIoKS5zdGFydCgpO1xuICB0cnkge1xuICAgIGNvbnN0IHdyaXRlciA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGRzdFBhdGgpO1xuICAgIGNvbnN0IHJlc3BvbnNlU3RyZWFtID0gKGF3YWl0IGF4aW9zKHJlcXVlc3RPcHRzKSkuZGF0YTtcbiAgICByZXNwb25zZVN0cmVhbS5waXBlKHdyaXRlcik7XG5cbiAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICByZXNwb25zZVN0cmVhbS5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICB3cml0ZXIub25jZSgnZmluaXNoJywgcmVzb2x2ZSk7XG4gICAgICB3cml0ZXIub25jZSgnZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICByZXNwb25zZVN0cmVhbS51bnBpcGUod3JpdGVyKTtcbiAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRvd25sb2FkIHRoZSBmaWxlIGZyb20gJHtyZW1vdGVVcmx9OiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIGlmICghaXNNZXRlcmVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qgc2Vjb25kc0VsYXBzZWQgPSB0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcztcbiAgY29uc3Qge3NpemV9ID0gYXdhaXQgZnMuc3RhdChkc3RQYXRoKTtcbiAgbG9nLmRlYnVnKGAke3JlbW90ZVVybH0gKCR7dG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9KSBgICtcbiAgICBgaGFzIGJlZW4gZG93bmxvYWRlZCB0byAnJHtkc3RQYXRofScgaW4gJHtzZWNvbmRzRWxhcHNlZC50b0ZpeGVkKDMpfXNgKTtcbiAgaWYgKHNlY29uZHNFbGFwc2VkID49IDIpIHtcbiAgICBjb25zdCBieXRlc1BlclNlYyA9IE1hdGguZmxvb3Ioc2l6ZSAvIHNlY29uZHNFbGFwc2VkKTtcbiAgICBsb2cuZGVidWcoYEFwcHJveGltYXRlIGRvd25sb2FkIHNwZWVkOiAke3RvUmVhZGFibGVTaXplU3RyaW5nKGJ5dGVzUGVyU2VjKX0vc2ApO1xuICB9XG59XG5cbmV4cG9ydCB7IHVwbG9hZEZpbGUsIGRvd25sb2FkRmlsZSB9O1xuIl0sImZpbGUiOiJsaWIvbmV0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
